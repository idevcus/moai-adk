---
name: moai:3-sync
description: 문서 동기화 + TAG 검증 + Git 자동화 (자동 모드)
argument-hint: "[target-path]"
tools: Bash, Task
model: sonnet
---

# MoAI-ADK 3단계: 문서 동기화 + TAG 검증 + Git 자동화

**동기화 대상**: ${ARGUMENTS:-"전체 프로젝트"}

## 개요

코드-문서 동기화, TAG 무결성 검증, Git 작업 자동화를 4단계로 순차 실행합니다.

### 핵심 기능

- **스마트 분석**: 프로젝트 상태 분석 및 동기화 계획 자동 수립
- **문서 동기화**: Living Document 실시간 동기화 (doc-syncer)
- **TAG 검증**: 코드 스캔 기반 TAG 무결성 검증 (tag-agent)
- **Git 자동화**: 구조화된 커밋 및 브랜치 동기화 (git-manager)

---

## 실행 순서

### Phase 1: 분석 및 계획 (명령어 레벨)

프로젝트 상태를 분석하여 동기화 계획을 수립합니다:

#### 1. 프로젝트 상태 분석

sync-analyzer 스크립트를 실행하여 다음 정보를 수집합니다:
- Git 상태: 변경된 파일, 브랜치 상태, 커밋 히스토리
- 문서 일치성: 코드-문서 간 동기화 필요성
- TAG 시스템: @TAG 체계 검증 및 끊어진 링크
- 동기화 범위: 전체 vs 부분 vs 특정 경로

#### 2. 동기화 전략 결정

분석 결과를 바탕으로 자동으로 최적 전략을 선택합니다:

- **안전한 변경** (파일 < 5개): 고속 자동 실행 (5-10초)
- **중간 규모 변경**: 확인 후 실행 (15-25초)
- **대규모 변경** (파일 > 50개): 중단 및 수동 확인 권장

#### 3. 동기화 계획 보고서 생성

다음 형식으로 계획을 제시합니다:

```
## 문서 동기화 계획 보고서: [TARGET]

### 상태 분석 결과
- 변경된 파일: [개수 및 유형]
- 동기화 필요성: [높음/중간/낮음]
- TAG 시스템 상태: [정상/문제 감지]

### 동기화 전략
- 동기화 범위: [전체/부분/선택적]
- 예상 실행 시간: [시간]
- 사용자 확인: [필요/불필요]

### 주의사항
- 잠재적 충돌: [문서 충돌 가능성]
- TAG 문제: [끊어진 링크, 중복 TAG]

### 예상 산출물
- sync-report.md: [동기화 결과 요약]
- TAG 검증 보고서: [코드 스캔 기반 무결성 검증]
- Living Documents: [갱신된 문서 목록]

---
승인 요청: 위 계획으로 동기화를 진행하시겠습니까?
("진행", "수정 [내용]", "중단" 중 선택)
```

#### 4. 사용자 확인 (조건부)

**자동 실행 조건** (안전한 변경 감지 시):
- 변경 파일 < 5개
- 문서 변경 < 3개
- TAG 문제 없음
→ 즉시 Phase 2로 진행

**확인 필요 시**:
- "진행" 또는 "시작": Phase 2 동기화 시작
- "수정 [구체적 변경사항]": 계획 수정 후 재검토
- "중단": 동기화 작업 중단

---

### Phase 2: 문서 동기화 (doc-syncer 전담)

사용자 승인 후 doc-syncer 에이전트를 호출합니다:

```
@agent-doc-syncer "승인된 계획: ${ARGUMENTS:-"전체 프로젝트"}의 문서 동기화를 수행해주세요"
```

#### doc-syncer 작업 영역
- Living Document 동기화: 코드 ↔ 문서 자동 반영
- 문서-코드 일치성 검증: 불일치 감지 및 수정
- API 문서 자동 생성/갱신: 소스코드 → 문서 변환
- README 및 아키텍처 문서: 프로젝트 구조 반영
- sync-report.md 생성: 동기화 결과 요약

#### 완료 기준
- Living Document 동기화 완료
- sync-report.md 생성/갱신
- 문서-코드 일치성 검증
- 다음 Phase로 전달할 정보 준비:
  - 업데이트된 문서 목록
  - sync-report.md 경로
  - 잠재적 고아 TAG 목록
  - 끊어진 링크 개수

---

### Phase 3: TAG 검증 (tag-agent 전담)

문서 동기화 후 tag-agent를 호출합니다:

```
@agent-tag-agent "동기화된 문서와 코드에서 @TAG를 스캔하고 무결성을 검증해주세요"
```

#### tag-agent 작업 영역

**1. 코드 기반 TAG 스캔**:
- 정규식 패턴으로 모든 소스 파일에서 TAG 실시간 추출
- 지원 파일: `.md`, `.ts`, `.js`, `.py`, `.java`, `.go`, `.rs`, `.cpp`, `.c`, `.h`
- 수집 정보: TAG ID, 타입, 카테고리, 파일 위치, 주변 컨텍스트

**핵심 원칙**: TAG의 진실은 코드 자체에 존재하며, 별도 인덱스 캐시 없이 실시간 스캔합니다.

**2. TAG 무결성 검증**:
- 고아 TAG 감지: 부모 TAG가 없는 TAG
- 끊어진 참조 감지: 존재하지 않는 TAG 참조
- 중복 TAG 감지: 동일 ID의 중복 사용
- Primary Chain 검증: @REQ → @DESIGN → @TASK → @TEST

**3. 자동 수정 제안**:
- 끊어진 링크 복구 방안 제시
- 중복 TAG 병합 제안
- 고아 TAG 정리 권장사항

#### 완료 기준
- 전체 프로젝트 코드 스캔 완료
- 모든 @TAG 실시간 추출 및 검증
- TAG 무결성 검증 완료
- 다음 Phase로 전달할 정보 준비:
  - 스캔한 파일 개수
  - 발견한 TAG 총 개수
  - 고아 TAG 목록
  - 끊어진 참조 목록
  - 중복 TAG 목록
  - 자동 수정된 문제 개수

---

### Phase 4: Git 작업 자동화 (git-manager 전담)

문서 동기화 및 TAG 검증 완료 후 git-manager를 호출합니다:

```
@agent-git-manager "문서 동기화 및 TAG 업데이트 완료된 변경사항의 커밋과 브랜치 동기화를 수행해주세요"
```

#### git-manager 작업 영역
- 구조화된 커밋: 문서 동기화 커밋 (📝SYNC)
- TAG 정보 포함: 커밋 메시지에 TAG 변경사항 자동 삽입
- 브랜치 동기화: Personal/Team 모드별 Git 전략 적용
- PR 상태 전환: Draft → Ready (Team 모드)
- 체크포인트 생성: 동기화 완료 상태 백업 포인트

#### 완료 기준
- 문서 동기화 커밋 완료
- 브랜치 동기화 성공
- PR 상태 전환 (팀 모드)
- 체크포인트 생성 완료

---

## 인수 처리

### 경로 지정
- `$1 (경로)`: 동기화 대상 경로 (선택사항, 기본값: 전체 프로젝트)

### 사용 예시

```bash
# 전체 프로젝트 동기화 (기본값)
/moai:3-sync

# 특정 경로 동기화
/moai:3-sync docs/api/

# 특정 파일 동기화
/moai:3-sync README.md
```

---

## 성능 지표

| 변경 규모 | 실행 시간 | 사용자 확인 | 주요 특징 |
|----------|----------|-------------|----------|
| **소규모** (< 5 파일) | 5-10초 | 자동 실행 | 일상적 동기화 (80% 케이스) |
| **중규모** (5-50 파일) | 15-25초 | 확인 필요 | 중요한 변경 |
| **대규모** (> 50 파일) | - | 중단 권장 | 수동 확인 및 분할 작업 |

---

## 결과 보고

동기화 완료 후 다음 형식으로 결과를 보고합니다:

### 성공적인 동기화

```
✅ 문서 동기화 완료
📊 처리 결과: 파일 12개 업데이트, 문서 5개 생성, TAG 48개 검증
⏱️ 실행 시간: 18.4초
🚀 다음 기능 개발 준비 완료
```

### 부분 동기화 (문제 감지)

```
⚠️ 부분 동기화 완료 (문제 발견)

🔴 해결 필요한 문제:
├── 끊어진 링크: X개
├── 중복 TAG: X개
└── 고아 TAG: X개

🛠️ 자동 수정 권장사항:
1. 끊어진 링크 복구
2. 중복 TAG 병합
3. 고아 TAG 정리
```

---

## 다음 단계 안내

### 개발 사이클 완료

```
🔄 MoAI-ADK 3단계 워크플로우 완성:
✅ /moai:1-spec → EARS 명세 작성
✅ /moai:2-build → TDD 구현
✅ /moai:3-sync → 문서 동기화

🎉 다음 기능 개발 준비 완료
> /moai:1-spec "다음 기능 설명"
```

---

## 제약사항

### 환경 의존성
- Git 저장소 필수
- gh CLI (GitHub 통합 시 필요)
- TypeScript/Node.js (TAG 검증 스크립트)

### 전제 조건
- MoAI-ADK 프로젝트 구조 (.moai/, .claude/)
- TDD 구현 완료 상태
- TRUST 5원칙 준수

### 제한 사항
- TAG 검증은 파일 존재 기반 체크
- PR 자동 전환은 gh CLI 환경에서만 동작
- 커버리지 수치는 별도 측정 필요

---

**doc-syncer, tag-agent, git-manager 에이전트와 연동하여 코드-문서 일치성 향상과 @TAG 추적성 보장을 목표로 합니다.**