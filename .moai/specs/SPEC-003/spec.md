# SPEC-003: 서브에이전트 가이드라인 표준화

## @REQ:AGENT-003 프로젝트 컨텍스트

### 배경

MoAI-ADK는 Claude Code 생태계 확장자(3차 사용자)를 지원하여 사용자 정의 에이전트/명령어를 통한 도메인별 워크플로우 구축을 목표로 합니다. 현재 @TASK:AGENT-GUIDE-001에서 "에이전트별 입력/출력 스키마 정의" 문제와 7개 핵심 에이전트 중 2개 비활성화 문제를 해결해야 합니다.

### 문제 정의

- **현재 상태**: 에이전트 간 일관성 없는 인터페이스로 인한 통합 복잡성
- **핵심 문제**: 사용자 정의 에이전트 개발 시 표준 가이드라인 부재
- **비즈니스 영향**: 에이전트 생태계 확장 저해 및 개발자 경험 저하

### 목표

1. 에이전트별 표준 입력/출력 스키마 정의 및 적용
2. 에이전트 간 안전한 호출 규칙 및 오케스트레이션 체계 구축
3. 3차 사용자의 사용자 정의 에이전트 개발 지원 강화

## @DESIGN:AGENT-SYSTEM-003 환경 및 가정사항

### Environment (환경)

- **시스템**: Claude Code 환경 (.claude/ 디렉토리 기반)
- **에이전트**: 기존 7개 핵심 에이전트 (spec-builder, code-builder, doc-syncer 등)
- **통합**: JSON 기반 에이전트 간 통신
- **확장**: Markdown 기반 에이전트 정의 시스템

### Assumptions (가정사항)

- Claude Code의 에이전트 시스템 API가 안정적임
- 기존 에이전트들의 기본 기능은 유지됨
- 개발자가 Markdown과 JSON 형식을 이해하고 있음
- .claude/agents/moai/ 디렉토리 구조가 유지됨

## @TASK:IMPLEMENT-003 요구사항 명세

### R1. 에이전트별 표준 입력/출력 스키마 정의

**WHEN** 새로운 에이전트가 개발되거나 기존 에이전트가 수정될 때,
**THE SYSTEM SHALL** 표준화된 입력/출력 스키마를 준수하도록 검증해야 함

**상세 요구사항:**

- 모든 에이전트의 입력 파라미터 JSON 스키마 정의
- 에이전트 출력 형식 표준화 (성공/실패/부분성공)
- 에러 처리 및 로깅 형식 통일
- 에이전트 메타데이터 (버전, 종속성, 권한) 정의

### R2. 에이전트 간 호출 규칙 및 오케스트레이션

**WHEN** 에이전트가 다른 에이전트를 호출해야 할 때,
**THE SYSTEM SHALL** 정의된 호출 규칙을 따르고 순환 참조를 방지해야 함

**상세 요구사항:**

- 에이전트 간 호출 그래프 정의 및 검증
- 순환 참조 및 무한 루프 방지 메커니즘
- 에이전트 실행 컨텍스트 관리 (상태, 세션, 권한)
- 에이전트 실행 타임아웃 및 리소스 제한

### R3. 사용자 정의 에이전트 개발 지원

**WHEN** 3차 사용자가 새로운 에이전트를 개발할 때,
**THE SYSTEM SHALL** 완전한 개발 가이드라인과 템플릿을 제공해야 함

**상세 요구사항:**

- 에이전트 개발 템플릿 (.md 파일 형식)
- Step-by-step 개발 가이드 문서
- 에이전트 테스팅 프레임워크 및 도구
- 예제 에이전트 (단순/중간/복잡한 3가지 수준)

### R4. 에이전트 품질 검증 도구

**WHEN** 에이전트가 시스템에 등록되거나 업데이트될 때,
**THE SYSTEM SHALL** 자동으로 품질 및 호환성을 검증해야 함

**상세 요구사항:**

- 에이전트 스키마 유효성 검사
- 에이전트 실행 안전성 검증 (샌드박스 테스트)
- 기존 시스템과의 호환성 검사
- 성능 및 리소스 사용량 프로파일링

## @TEST:ACCEPTANCE-003 Acceptance Criteria

### AC1. 표준 스키마 준수

**Given** 새로운 에이전트를 개발할 때
**When** 표준 템플릿을 사용하여 에이전트를 작성하면
**Then** 모든 입력/출력이 정의된 JSON 스키마를 준수해야 하고, 스키마 검증이 통과해야 함

### AC2. 안전한 에이전트 간 호출

**Given** 에이전트 A가 에이전트 B를 호출할 때
**When** 정의된 호출 규칙에 따라 호출하면
**Then** 순환 참조 없이 안전하게 실행되고, 호출 컨텍스트가 올바르게 전달되어야 함

**Given** 에이전트 호출 그래프에서 순환 참조가 감지될 때
**When** 시스템 검증을 실행하면
**Then** 순환 참조 경고가 표시되고 수정 방법이 제안되어야 함

### AC3. 사용자 정의 에이전트 개발 지원

**Given** 3차 사용자가 새로운 도메인별 에이전트를 개발할 때
**When** 제공된 템플릿과 가이드를 따라 개발하면
**Then** 기존 MoAI 시스템과 완전히 호환되고, 4단계 워크플로우에 통합 가능해야 함

**Given** 에이전트 개발 가이드를 따를 때
**When** 예제 에이전트를 참조하면
**Then** 단순/중간/복잡한 수준별로 적절한 참조 예제가 제공되어야 함

### AC4. 에이전트 품질 검증

**Given** 새로운 에이전트가 시스템에 등록될 때
**When** 자동 품질 검증을 실행하면
**Then** 스키마, 안전성, 호환성, 성능 검사가 모두 통과해야 함

**Given** 에이전트 검증 중 문제가 발견될 때
**When** 검증 리포트를 확인하면
**Then** 구체적인 문제점과 수정 방법이 명시되어야 함

## 범위 및 모듈

### In Scope

- 7개 기존 에이전트의 스키마 표준화
- 에이전트 간 호출 규칙 정의 및 구현
- 사용자 정의 에이전트 개발 템플릿 및 가이드
- 에이전트 검증 도구 및 테스팅 프레임워크
- 에이전트 호출 그래프 관리 시스템

### Out of Scope

- Claude Code 내부 API 수정 (외부 제어 불가)
- 에이전트 실행 성능 최적화 (별도 SPEC에서 처리)
- 다른 AI 플랫폼과의 호환성 (Claude Code 전용)
- 에이전트 버전 관리 시스템 (초기 버전에서 제외)

## 기술 노트

### 구현 기술

- **스키마 정의**: JSON Schema + OpenAPI 3.0 스타일
- **에이전트 정의**: Markdown + YAML frontmatter
- **검증 도구**: Python JSON 스키마 검증 라이브러리
- **테스팅**: pytest 기반 에이전트 테스트 프레임워크

### 의존성

- 기존 .claude/agents/moai/ 디렉토리 구조
- Claude Code 에이전트 실행 환경
- JSON 처리 라이브러리 (Python 표준 라이브러리)

### 아키텍처 고려사항

- 에이전트 간 느슨한 결합 (loose coupling) 유지
- 에이전트 실행 격리 (각 에이전트는 독립적 실행)
- 확장 가능한 스키마 설계 (미래 요구사항 대응)

### 보안 고려사항

- 에이전트 실행 권한 제한 및 검증
- 사용자 입력 검증 및 살균 (sanitization)
- 에이전트 간 데이터 전달 시 민감정보 보호

## 추적성

### 연결된 요구사항

- @TASK:AGENT-GUIDE-001: 에이전트별 입력/출력 스키마 정의
- @REQ:USER-001: 3차 사용자(생태계 확장자) 지원
- @STRUCT:ARCHITECTURE-001: Claude Extensions 계층 표준화

### 구현 우선순위

1. 기존 에이전트 스키마 정의 (High)
2. 에이전트 간 호출 규칙 구현 (High)
3. 사용자 정의 에이전트 템플릿 (Medium)
4. 에이전트 검증 도구 (Medium)

### 테스트 전략

- 단위 테스트: 각 에이전트별 스키마 검증 테스트
- 통합 테스트: 에이전트 간 호출 시나리오 테스트
- E2E 테스트: 사용자 정의 에이전트 개발 전체 시나리오

## 에이전트 표준 스키마 예시

### 입력 스키마 템플릿

```json
{
  "type": "object",
  "properties": {
    "command": {
      "type": "string",
      "description": "에이전트 실행 명령"
    },
    "parameters": {
      "type": "object",
      "description": "에이전트별 파라미터"
    },
    "context": {
      "type": "object",
      "properties": {
        "session_id": { "type": "string" },
        "user_id": { "type": "string" },
        "permissions": { "type": "array" }
      }
    }
  },
  "required": ["command", "context"]
}
```

### 출력 스키마 템플릿

```json
{
  "type": "object",
  "properties": {
    "status": {
      "type": "string",
      "enum": ["success", "failure", "partial_success"]
    },
    "data": {
      "type": "object",
      "description": "에이전트 실행 결과"
    },
    "errors": {
      "type": "array",
      "items": { "type": "string" }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "execution_time": { "type": "number" },
        "resources_used": { "type": "object" }
      }
    }
  },
  "required": ["status"]
}
```
